# Unikernel monitor项目的可行性报告

## 明确目标：我们要做什么？

Unikernel作为近年来出现的一种制作功能专一化的极简虚拟机镜像的方法受到了大家的关注，目前来讲，它所面临的问题大致如下：

1. 单进程执行
2. 单用户限制（如果这可以看作一种缺点的话）
3. 对于一些错误处理，监视状态方面的局限性。
4. 在QEMU等监视器下的多余接口可以进一步进行优化。
5. 对于其中的应用程序进行版本滚动的时候，必须重新编译整个程序。

而我们要做的 Unikernel Monitor，就是为了解决第三个和第四个问题。我们想要在Hypervisor 和 unikernel之间加一层，而这
一层的作用在于：它可以监视Unikernel的状态，像管理一个应用程序一样管理一个Unikernel。如果它坏了，我们还要能够提供一定
的隔离机制和日志信息，来允许开发者在不需要重现错误的情况下得到错误信息。

## 为什么可以这样做？

### 先从虚拟化技术谈起

虚拟化技术其实就是一种仿真模拟技术，让程序“以为”自己占有整个硬件，每一个运行的进程都以为它是系统唯一的进程，占有了所有
的CPU时间，换句话说，虚拟化技术使得程序在实际设备上的运行 P 和在一台“理想”的设备上运行 P' 从运行结果上来讲是等价的，而
且程序并不需要为虚拟化做出任何的改变。

也就是说，虚拟化技术其实并没有改变程序本身的任何性质，任何程序本身就可以做到的事，只要提供了相应的虚拟化手段，就可以在虚
拟机中做到，这种虚拟化之后的程序运行的性质不变，决定我们一定可以实现对它的管理和监视。

这种技术为我们带来了很多实用的功能：从硬件上来讲，有各种链路的多路复用，从操作系统层面上，有文件系统的隔离。而且虚拟化所
带来的各种管理层面上的优势，比如我可以已非常低的开销进行整机克隆，有巨大的可移植性，总之虚拟机提供的更深层次的隔离使得基
于虚拟机创建网络服务变得非常方便，并且相对安全。

### Unikernel这样的改变意味着什么？

Unikernel这样重新思考操作系统的组织形式，尤其是对于云计算平台提供服务的模式来说，它重新定义了我们认识一个“服务”（包括应
用程序，虚拟机等）的提供形式，在传统的思维中，我们通常认为所有的服务都是准备好处理用户请求的，这也就意味着我们需要应对各
种各样可能的请求，为每一种请求提供对应的服务，即便事实上它并不需要。那么，我们应该考虑如下问题：我们可不可以根据用户的需
求提供服务呢？Unikernel的设计和实践告诉我们这是可以的，而且对我们来说有极大的好处。

首先，如果能在短时间内（毫秒级）建立用户所需要的服务，那么我们完全可以不让所有可能的服务处于“空转”状态，而是一种近似于“
按需分配”的方式提供给用户，这将大大节省计算资源。

其次，我们这样做减少了可能的攻击面（attack surface）因为冗余的服务都被剔除了，精简就意味着可能用来发动攻击的资源少。

### 目前的QEMU监视器

通常情况下，我们是如何管理虚拟机的？我们需要一个虚拟机管理程序，用来实现虚拟机的加载，执行，通信和关闭，也就是说，监视器
其实是hypervisor和虚拟机之间的“接口”。

### 需要改变什么

目前的问题是：我们能不能跳出虚拟机本身，将类似QEMU的中间层也进行“专门化”呢？那样的结果会不会让Unikernel更加快而且抹去中
间的又一层之后方便我们进行管理呢？

#### 改变1：Unikernel的构建方式

以mirage为例，在以往的Unikernel的构建上，使用了OCaml语言，配合安装的各种包找到程序需要的各种服务，在此基础上进行“剪裁”，
得到了一个极其精简的虚拟机镜像。现在想：如果我在构建Unikernel的时候也将所需要与hypervisor进行通信所需要的服务也包括进来，
并依此进行“剪裁”，得到一个和monitor打包成一体的镜像，那样的虚拟机就可以直接跑在hypervisor上了。

所以我们需要改变其构建方式，unikernel需要什么样的服务，我们就让monitor提供什么样的服务，依旧是不多也不少。

#### 改变2：具体的接口

我们希望开发的monitor能够为我们提供尽可能多的信息，并且改善unikernel在bug出现时的处理机制，使得我们可以像调试一个通常的
应用程序一样调试一个unikernel，这些都可以用monitor来完成，因此我们计划重新设计monitor，并作为一个unikernel构建过程中的
基础组件。

#### 改变3：monitor和hypervisor的接口

我们并不打算亲自实现monitor的所有功能，对于现有的qemu接口，方便使用的我们会直接拿来使用，然而问题在于，要想增强其功能（比如
状态监视）就一定要增加monitor和unikernel之间的接口，同样作为一个中间层来说，hypervisor也要提供相应的接口完成这个功能。

#### 一个设想（具体可行性未讨论）

能不能完全像管理一个应用程序一样管理unikernel呢？我们希望monitor提供的接口能够提供像一个正常的应用程序一样的抽象，那样会不
会让unikernel的部署难度降低呢？